!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define(factory):(global=global||self).gotpl=factory()}(this,function(){"use strict";var LINE_RE=/\r?\n/g,INDENT_RE=/[\r\n]+([\f\t\v]*)/g,ESCAPE_RE=/["'&<>]/,TYPEOF_RE=/typeof ([$\w]+)/g,tplCache={},fileCache={},defOpts={root:"",debug:!1,cache:!0,minify:!0,openTag:"<%",closeTag:"%>"};function merge(target,objects){var arguments$1=arguments;target=target||{};for(var loop=function(i,l){var object=arguments$1[i];object&&Object.keys(object).forEach(function(key){target[key]=object[key]})},i=1,l=arguments.length;i<l;++i)loop(i);return target}function renderByPath(path,template,data,options){var filename=function(filename,base){var path=require("path");return path.isAbsolute(filename)||(base=base?path.resolve(base):defOpts.root,path.extname(base)&&(base=path.dirname(base)),filename=path.join(base,filename)),path.extname(filename)||(filename+=".tpl"),filename}(path,(options=merge({},defOpts,options)).filename||options.root),compiled=fileCache[filename];compiled||(options.filename=filename,compiled=compile(template=template||require("fs").readFileSync(filename).toString(),data,options),options.cache&&!options.debug&&(fileCache[filename]=compiled));try{return compiled(data)}catch(e){throw fileCache[filename]=null,e}}function renderFileSync(path,data,options){return renderByPath(path,null,data,options)}function compile(template,data,options){data=merge({},data),options=merge({},defOpts,options);var lines=1,debug=options.debug,minify=options.minify,openTag=options.openTag,closeTag=options.closeTag,codes="return function(__data__){\n'use strict'\n";return codes+=debug?"try{var $$line=1,":"var ",template.replace(TYPEOF_RE,function(_,$1){data[$1]=data[$1]||void 0}),Object.keys(data).forEach(function(key){codes+=key+"=__data__['"+key+"'],"}),codes+="$$res=''\n",template.split(closeTag).forEach(function(segment){var logicCode,split=segment.split(openTag),html=split[0],logic=split[1];if(html){var htmlCode=function(codes){return"$$res+="+JSON.stringify(codes)}(html);htmlCode=minify?htmlCode.replace(INDENT_RE,"\\n"):htmlCode.replace(INDENT_RE,"\\n$1"),codes+=htmlCode+"\n",debug&&(lines+=html.split(LINE_RE).length-1,codes+="$$line="+lines+";\t")}logic&&(logicCode=0===logic.indexOf("=")?parseValue(logic.slice(1),!0):0===logic.indexOf("-")?parseValue(logic.slice(1)):logic.trim(),codes+=logicCode+"\n",debug&&(lines+=logic.split(LINE_RE).length-1,codes+="$$line="+lines+";\t"))}),codes+="return $$res",codes+=debug?"\n}catch(e){\n$$rethrow(e, $$template, $$line)\n}\n}":"\n}",new Function("$$template, $$escape, $$rethrow, include",codes)(template,escapeHTML,rethrow,function(path,subData,subOptions){return renderFileSync(path,subData=merge({},data,subData),subOptions=merge({},options,subOptions))})}function parseValue(codes,escape){return escape&&(codes="$$escape("+codes.trim()+")"),"$$res+=("+codes+")"}function escapeHTML(value){var html=""+value,match=ESCAPE_RE.exec(html);if(!match)return value;for(var result="",lastIndex=0,i=match.index,length=html.length;i<length;i++){var charCode=html.charCodeAt(i);34!==charCode&&38!==charCode&&39!==charCode&&60!==charCode&&62!==charCode||(lastIndex!==i&&(result+=html.substring(lastIndex,i)),lastIndex=i+1,result+="&#"+charCode+";")}return lastIndex!==i&&(result+=html.substring(lastIndex,i)),result}function rethrow(err,template,line){var lines=template.split(LINE_RE),start=Math.max(line-3,0),end=Math.min(lines.length,line+3);throw err.message+="\n\n"+lines.slice(start,end).map(function(codes,i){var curLine=start+i+1;return(curLine===line?" >> ":"    ")+curLine+"| "+codes}).join("\n")+"\n",err}return{config:function(options){"object"==typeof options?merge(defOpts,options):2===arguments.length&&(defOpts[options]=arguments[1])},render:function(template,data,options){var compiled=tplCache[template];compiled||(compiled=compile(template,data,options=merge({},defOpts,options)),options.cache&&!options.debug&&(tplCache[template]=compiled));try{return compiled(data)}catch(e){throw tplCache[template]=null,e}},renderFile:function(path,data,options,next){var fs=require("fs");if("function"==typeof data?(next=data,data=options=null):"function"==typeof options&&(next=options,options=null),!next)return new Promise(function(resolve,reject){fs.readFile(path,function(err,buffer){if(err)reject(err);else try{resolve(renderByPath(path,buffer.toString(),data,options))}catch(err){reject(err)}})});fs.readFile(path,function(err,buffer){if(err)next(err);else try{next(null,renderByPath(path,buffer.toString(),data,options))}catch(err){next(err)}})},renderFileSync:renderFileSync,compile:compile,version:"7.0.1"}});